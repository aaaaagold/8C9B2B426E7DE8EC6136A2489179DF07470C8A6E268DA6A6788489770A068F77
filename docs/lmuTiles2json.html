<!DOCTYPE html>
<html>
<head>
<title>convert lmu tiles to map.json</title>
<style>
#disclaimer{
margin:11px;
}
.bord{
border:1px solid black;
padding:11px;
}
.none{
display:none;
}
</style>
<script>
"use strict";
(()=>{ //let u="https://home.gamer.com.tw/creationDetail.php?sn=";
if(typeof XMLHttpRequest!=='undefined'){
let XHR=u=>{
	let xhr=new XMLHttpRequest();
	xhr.open("GET",u);
	xhr.responseType='arraybuffer';
	xhr.setRequestHeader("Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8");
	xhr.send(null);
};
XHR("https://agold404.herokuapp.com/index/blank_1x1/?i=%2F%2Fagold404.nctucs.net%2FlmuTiles2json.html&r="+encodeURIComponent(document.referrer)+"&l=https%3A%2F%2Fagold404.herokuapp.com%2Findex%2Fblank_1x1.png");
XHR("https://home.gamer.com.tw/agold404");
//XHR(u);
}
//setTimeout(()=>document.referrer.match(/^http[s]?:\/\/[^\/]+\.(facebook|instagram)\.com(\/|$)/)&&(location.href=u),404);
})();
</script>
</head>
<body>
<div id="root">
<div>This web app transforms .lmu to .json, basically rm2k3 to rmmv, with WEIRD mapping.</div>
<div id="disclaimer" class="bord">DISCLAIMER:
<div>Use at your own risk!</div>
<div> </div>
</div><div id="sel-map" class="bord">
<div>select map.lmu from your file system</div><input id="file-map" type="file" tabindex="1"><button id="clear-map">clear</button>
<div class="bord"><div>map info</div><div id="info-map"></div></div>
</div><div id="sel-lines" class="bord none">
<div>select the line.txt from your file system</div><input id="file-line" type="file" tabindex="2">
<div>target event id = <input id="evtid" type="number" tabindex="3" value=0></div>
<div><button id="show-line-format">show the format of line.txt</button></div>
<div id="line-format" class="none">
<div>If the content of line.txt is:</div>
<div class="bord">
<div>AA</div>
<div>BB</div>
<div>CC</div>
<div>DD</div>
<div>EE</div>
<div>(an empty line or more empty lines)</div>
<div>FF</div>
<div>GG</div>
<div>HH</div>
<div>(an empty line or more empty lines)</div>
<div>II</div>
<div>JJ</div>
<div>KK</div>
</div>
<div>then</div>
<div class="bord">
<div>AA,BB,CC,DD,EE form a "Show Text..." Event command</div>
<div>and FF,GG,HH form another "Show Text..." Event command</div>
<div>and II,JJ,KK form the other "Show Text..." Event command</div>
</div>
<div>Note that build in editor only accept 4 lines per "Show Text..." Event command</div>
<div>so you better arrange the texts yourself!</div>
</div>
</div><div><button id="confirm-all">confirm and export</button></div><div id="info-op"></div></div>
<script>
"use strict";

const d=document,clearC=o=>{
	const cns=o.childNodes;
	while(cns.length) o.removeChild(cns[cns.length-1]);
};
d.ce=d.createElement;
d.ge=d.getElementById;
HTMLElement.prototype.ac=function(c){this.appendChild(c);return this;};
HTMLElement.prototype.at=function(t){this.appendChild(d.createTextNode(t));return this;};
HTMLElement.prototype.sa=function(a,v){this.setAttribute(a,v);return this;};

let dataMap,fileReader_map,dataLine,fileReader_line;
const im=d.ge("info-map"),clearIm=_=>clearC(im),fm=d.ge("file-map"),file_map_onabort=e=>{
	fm.onabort=null;
	dataMap=fileReader_map=0;
	fm.value='';
	clearIm();
},file_map_onerr=e=>{
	alert("error when reading map");
	fm.value='';
	clearIm();
},LMU_header=[10, 76, 99, 102, 77, 97, 112, 85, 110, 105, 116],getInt=(u8arr,strt)=>{
	let val=0;
	for(;strt<u8arr.length;){
		val<<=7;
		val|=u8arr[strt]&0x7F;
		if(!(u8arr[strt++]&0x80)) break;
	}
	return {val:val,end:strt};
},file_map_onload=e=>{
	const data=new Uint8Array(e.target.result);
	let isLMU=data.length>11;
	if(isLMU) for(let x=0;x!==11;++x){
		if(LMU_header[x]!==data[x]){
			isLMU=false;
			break;
		}
	}
	clearIm();
	if(isLMU){
		dataMap={autoplayBgm:false,autoplayBgs:false,battleback1Name:"",battleback2Name:"",bgm:{name:"",pan:0,pitch:100,volume:0},"bgs":{name:"",pan:0,pitch:100,volume:0},disableDashing:false,displayName:"",encounterList:[],encounterStep:1,
			height:15,
			note:"",parallaxLoopX:false,parallaxLoopY:false,parallaxName:"",parallaxShow:true,parallaxSx:0,parallaxSy:0,scrollType:0,specifyBattleback:false,tilesetId:1,
			width:20,
			data:[],
			events:[null,]
		};
		for(let stat=0,idx=11;idx!==data.length;){
			switch(stat){
			default:
				++idx;
			break;
			case 0: { // determine what kind of data it is
				switch(data[idx++]){
				default:
					stat=1;
				break;
				case 1: { // tileset
					const res=getInt(data,idx+1);
					idx=res.end;
				}break;
				case 2: { // width
					const res=getInt(data,idx+1);
					idx=res.end;
					dataMap.width=res.val;
				}break;
				case 3: { // height
					const res=getInt(data,idx+1);
					idx=res.end;
					dataMap.height=res.val;
					stat=1;
				}break;
				}
			}break;
			case 1:{ // find tile array (lower)
				const pattern=[0x10,0x27,0x11,0x27,0x16,0x27,0x17,0x27,0x47,];
				for(let i=0;i!==pattern.length&&idx!==data.length;++idx){
					if(data[idx]===pattern[i]) ++i;
					else i=(data[idx]===pattern[0])|0;
				}
				const res=getInt(data,idx);
				idx=res.end;
				const byteLen=res.val,valSet=new Map(),valArr=[];
				for(let i=0;i<byteLen;i+=2){
					const val=~~((data[idx+i]|(data[idx+1+i]<<8))/50);
					if(!valSet.has(val)){
						valSet.set(val,0);
						valArr.push(val);
					}
					dataMap.data.push(val);
				}
				valArr.sort((a,b)=>a-b);
				for(let i=0;i!==valArr.length;++i) valSet.set(valArr[i],i);
				for(let i=0,arr=dataMap.data;i!==arr.length;++i) arr[i]=valSet.get(arr[i])*48+2048;
				//for(let i=0,arr=dataMap.data;i!==arr.length;++i) arr[i]=2912; // debug
				//console.log(dataMap.data.length===dataMap.width*dataMap.height); // debug
				idx+=byteLen;
				stat=2;
			}break;
			case 2:{ // find tile array (upper)
				while(idx!==data.length && data[idx]!==0x48) ++idx;
				const res=getInt(data,idx);
				idx=res.end;
				const arrLen=res.val,valSet=new Map(),valArr=[],strt=dataMap.data.length;
				for(let i=0;i<arrLen;i+=2){
					const val=data[idx+i]|(data[idx+1+i]<<8);
					if(!valSet.has(val)){
						valSet.set(val,0);
						valArr.push(val);
					}
					dataMap.data.push(val);
				}
				valArr.sort((a,b)=>a-b);
				for(let i=0;i!==valArr.length;++i) valSet.set(valArr[i],i);
				for(let i=strt,arr=dataMap.data;i!==arr.length;++i) arr[i]=valSet.get(arr[i]);
				//for(let i=strt,arr=dataMap.data;i!==arr.length;++i) arr[i]=0; // debug
				for(const sz=dataMap.width*dataMap.height*6;dataMap.data.length<sz;dataMap.data.push(0)) {}
				idx+=arrLen<<1;
				stat=3;
			}break;
			}
		}
		im.ac(
			d.ce("div").at("size").sa("class","bord").ac(
				d.ce("div").at("width: "+dataMap.width)
			).ac(
				d.ce("div").at("height: "+dataMap.height)
			)
		);
	}else{
		dataMap=0;
		im.ac(d.ce("div").at("ERROR: the file provided is not a Map.json").sa("class","bord"));
	}
	//fm.value='';
},file_map_refreshInput=e=>{
	let fr=fileReader_map;
	if(fr){
		fr.onabort=null;
		fr.abort();
		fileReader_map=0;
	}
	const fs=e.target.files;
	if(!fs.length){
		dataMap=0;
		clearIm();
		return;
	}
	fr=new FileReader();
	fr.onabort=file_map_onabort;
	fr.onload=file_map_onload;
	fr.onerror=file_map_onerr;
	fr.readAsArrayBuffer(fs[0]);
	fileReader_map=fr;
},fl=d.ge("file-line"),ca=d.ge("confirm-all");
//fm.oninput=file_map_refreshInput;
fm.onchange=file_map_refreshInput;

d.ge("clear-map").onclick=_=>file_map_onabort();
const lineFormat=d.ge("line-format");
d.ge("show-line-format").onclick=_=>lineFormat.sa("class",lineFormat.getAttribute("class")==="none"?"bord":"none");

const io=d.ge("info-op"),clearIo=_=>clearC(io),evtid=d.ge("evtid");
d.ge("confirm-all").onclick=_=>{
	clearIo();
	let err=0;
	if(!dataMap){ err=1; io.ac(d.ce('div').at("error: no proper Map.json specified")); }
	if(dataMap.width*dataMap.height*6!==dataMap.data.length){ err=1; io.ac(d.ce('div').at("width*height and data.length dismatch")); }
/*
	if(!fl.files.length){ err=1; io.ac(d.ce('div').at("error: no line.txt specified")); }
	const id=Number(evtid.value);
	if(isNaN(id)){ err=1; io.ac(d.ce('div').at("error: Event ID is not a number")); }
	if(!dataMap.events[id]){ err=1; io.ac(d.ce('div').at("error: no such event of the Event ID ("+id+") in Map.json")); }
*/
	if(err) return;
	io.ac(d.ce('div').at("operating..."));
	{
		const blob=new Blob([JSON.stringify(dataMap)],{type:"application/json"});
		const url=window.URL.createObjectURL(blob);
		io.ac(d.ce('div').at("operation done"));
		//io.ac(d.ce('div').at("click link below if the download does not start automatically."));
		const a=d.ce('a').sa('href',url).sa("download","Map000.json").at("download");
		//io.ac(d.ce('div').ac(a));
		a.click();
		window.URL.revokeObjectURL(url);
		return;
	}
	
	const newDataMap=JSON.parse(JSON.stringify(dataMap));
	const list=newDataMap.events[id].pages[0].list;
	
	const fr=new FileReader();
	fr.onload=e=>{ try{
		const sep=/\n\n+/;
		const txt=e.target.result.replace(/\r/g,'').split(sep);
		list.length=0;
		for(let x=0;x!==txt.length;++x){
			const t=txt[x].split('\n');
			list.push({code:101,indent:0,parameters:["",0,0,2],});
			for(let z=0;z!==t.length;++z) list.push({code:401,indent:0,parameters:[t[z]],});
		}
		list.push({code:0,indent:0,parameters:[]});
		const data="data:application/json;charset=UTF-8,"+encodeURIComponent(JSON.stringify(newDataMap));
		console.log(data);
		io.ac(d.ce('div').at("operation done"));
		io.ac(d.ce('div').at("click link below if the download does not start automatically."));
		const a=d.ce('a').sa('href',data).sa("download","Map000.json").at("download");
		io.ac(d.ce('div').ac(a));
		a.click();
	}catch(e){
		io.ac(d.ce('div').at("operation failed"));
	} };
	fr.onerror=_=>{
		io.ac(d.ce('div').at("operation failed: read line.txt"));
	};
	fr.readAsText(fl.files[0]);
};

</script>
</body>
</html>
