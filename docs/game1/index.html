<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="viewport" content="user-scalable=no">
	<link rel="icon" href="icon/icon.png" type="image/png">
	<link rel="apple-touch-icon" href="icon/icon.png">
	<!-- <link rel="stylesheet" type="text/css" href="fonts/gamefont.css"> -->
	<title>焚木工</title>
<style type="text/css">
body{font-family:Consolas,monospace,'Courier New',Courier,微軟正黑體,標楷體;}
.show-b{display:block;}
.show-i{display:inline;}
.show-ib{display:inline-block;}
.hide{display:none;}
.transparent{opacity:0;}
.tiny{margin:0px;border:0px solid rgba(0,0,0,0);padding:0px;width:0px;height:0px;}
.outofscreen{position:fixed;left:100%;top:100%;}
.none{display:none;}
button{
	display:inline-block;
	font-size:24px;
	color:#FFFFFF;background-color:#000000;opacity:0.875;
}
button:hover{
	background-color:#AAAA11;
}
.msg{
	position:relative;
	top:50%;
	display:block;
	font-size:24px;
	text-align:center;
	border:1px solid white;
	color:#FFFFFF;background-color:#000000;opacity:0.875;
}
</style>
<script src="dev.js"></script>
<script src="aes.js"></script>
<script>
"use strict";

var isDev,dev_kkk,dev_kk,jss;
//jss=undefined; //testing
//isDev=false; //testing
(()=>{
let w=window,d=document;
const ac=(p,c)=>{p.appendChild(c);return p},ce=(t)=>d.createElement(t),rc=(p,c)=>{p.removeChild(c);return p},sa=(e,a,v)=>{e.setAttribute(a,v);return e},tn=(txt)=>d.createTextNode(txt);
let isDev_=isDev,objs={};
if(isDev_) window.objs=objs;
if(!jss) jss=[
	"test.js",
	"js/plugins.js",
	":init",
	":lib_h",
	"js/libs/pixi.js",
	"js/libs/pixi-tilemap.js",
	"js/libs/pixi-picture.js",
	"js/libs/fpsmeter.js",
	"js/libs/lz-string.js",
	"js/libs/iphone-inline-video.browser.js",
	":lib_t",
	":obj_h",
	"js/rpg_core.js",
	"js/rpg_managers_h.js",
	"js/rpg_objects_h.js",
	"js/rpg_scenes_h.js",
	"js/rpg_sprites_h.js",
	"js/rpg_windows_h.js",
	"js/rpg_managers.js",
	"js/rpg_objects.js",
	"js/rpg_scenes.js",
	"js/rpg_sprites.js",
	"js/rpg_windows.js",
	":obj_t",
	":obj_t2",
	":strt",
	":chainWithGAS",
//	"js/main.js",
];

let waits=[],waits_i=0, putWaits=(p,c)=>{
	while(waits_i!==jss.length && waits[waits_i]){
		let scr=waits[waits_i++];
		if(scr!==true){ ac(d.body,scr); rc(d.body,scr); }
	}
},kkk=dev_kkk||"",kk=dev_kk||"",XHR=(url,callback,onerr,txt)=>{
	let xhr=new XMLHttpRequest();
	if(!txt) xhr.responseType='arraybuffer';
	if(onerr&&onerr.constructor===Function) xhr.onerror=function(){
		this.onerror=null;
		onerr();
	}
	if(callback&&callback.constructor===Function) xhr.onreadystatechange=function(){
		if (this.readyState === 4){
			let s = this.status.toString();
			if (s.length === 3 && s.slice(0, 1) === '2'){ this.onreadystatechange=null;
				callback(this.response);
			}
		}
	};
	xhr.open("GET",url);
	xhr.send(null);
	return;
},vars=[
"$gameTemp",
"$gameSystem",
"$gameScreen",
"$gameTimer",
"$gameMessage",
"$gameSwitches",
"$gameVariables",
"$gameSelfSwitches",
"$gameActors",

"$gameParty",
"$gameTroop",
"$gameMap",

"$gamePlayer",
]; objs._vars=vars; objs._vars_strArg=vars.slice();
const onloadProc=function f(){
	if(f.idx===0){
		if(!f.wait_blk){
			f.wait_blk=ce('div');
			ac(d.body,ac(f.wait_blk, ac(sa(ce('div'),"class","msg"),tn("讀取中請耐心等候")) ));
			f.wait_list={};
			for(let x=0;x!==jss.length;++x){
				let div=f.wait_list[jss[x]]=ac(sa(ce('div'),"class","msg"),tn(jss[x]));
				ac(f.wait_blk,div);
			}
		}
	}else{
		for(let x=f._lastIdx;x!==f.idx;++x){
			let div=f.wait_list[jss[x]];
			rc(div.parentNode,div);
		}
	}
	if(!isDev_){
		if(kkk===""){ XHR("https://agold404.herokuapp.com/game/game1.png",(response)=>{
			let u8arr=new Uint8Array(response);
			let s=''; for(let x=0;x!==u8arr.length;++x) s+=String.fromCharCode(u8arr[x]);
			let ua=navigator.userAgent;
			kkk=s;
			f();
		}); return; }
		if(kk===""){ XHR("https://agold404.herokuapp.com/game/game1.png?ip",(response)=>{
			let u8arr=new Uint8Array(response);
			if(u8arr.length) kk=String.fromCharCode(u8arr[u8arr.length-1]);
			else kk="-";
			f();
		}); return; }
	}
	f._lastIdx=f.idx;
	if(f.idx===jss.length){
		rc(f.wait_blk.parentNode,f.wait_blk); f.wait_blk=undefined;
		if(!isDev_) delete window.objs;
		let z,a;
		
		// refresh vars
		a=DataManager.createGameObjects;
		if(!objs.addScriptViaSrc){
			let rv=()=>objs._vars_objArg=objs._vars.map(x=>window[x]);
			z=DataManager.createGameObjects=function f(){ f.ori.call(this); rv(); }; z.ori=a;
			a=DataManager.extractSaveContents;
			z=DataManager.extractSaveContents=function f(contents){ f.ori.call(this,contents); rv(); }; z.ori=a;
		}else if(!a._refreshVars){
			let rv=()=>{ for(let i in objs._refreshVars) objs._refreshVars[i](); };
			a=z=DataManager.createGameObjects=function f(){
				objs.$gameTemp         = new Game_Temp();
				objs.$gameSystem       = new Game_System();
				objs.$gameScreen       = new Game_Screen();
				objs.$gameTimer        = new Game_Timer();
				objs.$gameMessage      = new Game_Message();
				objs.$gameSwitches     = new Game_Switches();
				objs.$gameVariables    = new Game_Variables();
				objs.$gameSelfSwitches = new Game_SelfSwitches();
				objs.$gameActors       = new Game_Actors();
				rv();
				objs.$gameParty        = new Game_Party();
				objs.$gameTroop        = new Game_Troop();
				objs.$gameMap          = new Game_Map();
				rv();
				objs.$gamePlayer       = new Game_Player();
				rv();
			};
			a=DataManager.extractSaveContents;
			z=DataManager.extractSaveContents=function f(contents){ f.ori.call(this,contents); rv(); }; z.ori=a;
		}
		
		// disable some buffers to reduce mem. usage
		//   not very effective (about 10%) (1GB -> 0.9GB)
		a=PIXI.glCore.createContext;
		z=PIXI.glCore.createContext=function f(canvas,opt){
			opt.alpha=opt.premultipliedAlpha=opt.depth=opt.stencil=opt.antialias=false;
			return f.ori.call(this,canvas,opt);
		}; z.ori=a;
		
		// testing-reserved block
		{}
		
		// handling plugins: ensure they're loaded before 'Scene_Boot'
		z=0; a=PluginManager.loadScript=function o(name){ ++z;
			let scr = d.ce('script');
			scr.onerror = this.onError.bind(this);
			scr.onload = o.o;
			scr._url = scr.src = this._path + name;
			d.body.ac(scr);
		};
		let O_O=()=>{ z=undefined; if(!SceneManager._scene) SceneManager.run(Scene_Boot); };
		a.o=()=>{ if(--z===0) O_O(); };
		PluginManager.setup($plugins);
		if(z===0) O_O(); // no plugins or loading is very fast
		
		return;
	}
	let scr=ce('script');
	let idx=f.idx;
	let src=jss[f.idx++];
	if(src[0]===":"){
		let gas="https://script.google.com/macros/s/AKfycbxKqePNqsycE-Y4FkmZEeCMcILjXaCRoMgUESaEI2iiSzCYmH0G/exec";
		let files="&file="+encodeURIComponent(src),isBody=onloadProc.isBody(src);
		while(f.idx!==jss.length && jss[f.idx][0]===":") if(onloadProc.isBody(jss[f.idx])===isBody) files+="&file="+encodeURIComponent(jss[f.idx++]); else break;
		if(isDev_) console.log(files);
		let k=Date.now()+''+Math.random();
		let xhr=new XMLHttpRequest();
		xhr.onreadystatechange=function() {
			if (this.readyState === 4) {
				let s = this.status.toString();
				if (s.length === 3 && s.slice(0, 1) === '2') {
					this.onreadystatechange=null;
					if(isDev_){ console.log(files,k); console.log(this.responseText); }
					let plain=aes(this.responseText.split(' ').map(x=>parseInt(x,16)),(kkk+kk+k).slice(0,32),1);
					if(isDev_) console.log(plain);
					if(onloadProc.isBody(src)){ if(isDev_) console.log("body",src);
						let rndkey=encodeURI(src)+Math.random();
						window[rndkey]=objs;
						let txt=onloadProc.addRefreshVars(plain,src);
						txt+="(window['"+rndkey+"']);";
						onloadProc.putScript(scr,txt);
						delete window[rndkey];
					}else onloadProc.putScript(scr,plain);
					f();
				}
			}
		}
		let cnt=4,go=()=>{
			if(--cnt===0) return f.giveupMsg();
			xhr.open("POST",gas+"?game=燒毀"+files+"&"+Date.now(),true);
			xhr.send(k);
		};
		xhr.onerror=()=>setTimeout(go,404);
		go();
	}else{
		let oriSrc=src;
		src+=src.indexOf("?")===-1?"?":"&"; src+=Date.now();
		if(isDev_){
			objs.addScriptViaSrc=undefined;
			scr.idx=idx;
			scr.onerror=f.onerr;
			scr.onload=f.onload;
			scr.src=src;
			ac(d.body,scr);
		}else{
			onloadProc.addScriptViaSrc(scr,oriSrc,true);
		}
	}
}; onloadProc.idx=0;
onloadProc.giveupMsg=()=>{
	rc(onloadProc.wait_blk.parentNode,onloadProc.wait_blk); onloadProc.wait_blk=undefined;
	ac(d.body,ac(sa(ce('div'),'class',"msg"),tn("遊戲壞掉了，重新整理或放棄吧。")));
};
onloadProc.onload=function(){ this.onload=null;
	rc(this.parentNode,this);
	onloadProc();
};
onloadProc.onerr=function f(){ this.onerror=null;
	let src=this.src; this.src='';
	this._errCnt^=0; if(++this._errCnt===4){
		return onloadProc.giveupMsg();
	}
	setTimeout(()=>{this.onerror=f; this.src=src;},404);
};
onloadProc.putScript=(scr,txt)=>{
	ac(d.body, ac(scr,tn(txt)) ); if(!isDev_) rc(d.body,scr);
};
onloadProc.addRefreshVars=(txt,src)=>{
	let us='"use strict";\n';
	let rtv=us;
	rtv+="((objs)=>{";
	rtv+=us;
	for(let x=0;x!==vars.length;++x) rtv+="var "+vars[x]+";\n";
	rtv+="\n";
	rtv+=txt;
	rtv+="\n";
	rtv+="if(!objs._refreshVars) objs._refreshVars={";
	rtv+="};\n";
	rtv+="objs._refreshVars['"+encodeURI(src)+"']=()=>{";
	rtv+=us;
	for(let x=0;x!==vars.length;++x) rtv+=vars[x]+"=objs."+vars[x]+"; if(window."+vars[x]+"!==undefined) window."+vars[x]+"="+vars[x]+"\n";
	rtv+="objs._vars_objArg=objs._vars.map(x=>window[x]||objs[x]);";
	rtv+="\n";
	rtv+="};\n";
	rtv+="})";
	return rtv;
};
onloadProc.isBody=(src)=>true
	&& src.slice(0,8)!=="js/libs/"
	&& src!=="js/plugins.js"
	&& src!=="js/rpg_core.js"
	&& src.indexOf("init")===-1
	&& src.slice(-5)!=="_h.js"
	&& src.slice(-2)!=="_h"
	&& true;
onloadProc.addScriptViaSrc=(scr,src,doNext)=>{
	let oriSrc=src;
	src+=src.indexOf("?")===-1?"?":"&"; src+=Date.now();
	let isBody=onloadProc.isBody(oriSrc);
	let cnt=4,req=()=>{
		if(isDev_) console.log(oriSrc,isBody);
		if(--cnt===0) return onloadProc.giveupMsg();
		XHR(src,(txt)=>{
			let rndkey=encodeURI(src)+Math.random();
			window[rndkey]=objs;
			if(isBody){
				txt=onloadProc.addRefreshVars(txt,oriSrc);
				txt+="(window['"+rndkey+"']);";
			}
			onloadProc.putScript(scr,txt);
			if(isDev_) window[oriSrc]=scr;
			delete window[rndkey];
			if(isDev_) console.log("xhr",oriSrc,onloadProc.idx);
			if(doNext) onloadProc();
		},req,1);
	};req();
}; objs.addScriptViaSrc=(scr,src)=>onloadProc.addScriptViaSrc(scr,src);
if(d.body) onloadProc(); else w.onload=()=>{ w.onload=null; onloadProc(); }
})();

</script>
</head>
<body style="background-color: black"></body>
</html>