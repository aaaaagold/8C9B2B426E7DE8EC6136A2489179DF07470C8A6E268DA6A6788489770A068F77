<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="viewport" content="user-scalable=no">
	<link rel="icon" href="icon/icon.png" type="image/png">
	<link rel="apple-touch-icon" href="icon/icon.png">
	<!-- <link rel="stylesheet" type="text/css" href="fonts/gamefont.css"> -->
	<title>焚木工</title>
<style type="text/css">
body{font-family:Consolas,monospace,'Courier New',Courier,微軟正黑體,標楷體;}
.show-b{display:block;}
.show-i{display:inline;}
.show-ib{display:inline-block;}
.hide{display:none;}
.transparent{opacity:0;}
.tiny{margin:0px;border:0px solid rgba(0,0,0,0);padding:0px;width:0px;height:0px;}
.outofscreen{position:fixed;left:100%;top:100%;}
.none{display:none;}
button{
	display:inline-block;
	font-size:24px;
	color:#FFFFFF;background-color:#000000;opacity:0.875;
}
button:hover{
	background-color:#AAAA11;
}
.msg{
	position:relative;
	top:50%;
	display:block;
	font-size:24px;
	text-align:center;
	border:1px solid white;
	color:#FFFFFF;background-color:#000000;opacity:0.875;
}
</style>
<script src="dev.js"></script>
<script src="aes.js"></script>
<script>
"use strict";

var isDev,jss;
//jss=undefined; //testing
(()=>{
let w=window,d=document;
const ac=(p,c)=>{p.appendChild(c);return p},ce=(t)=>d.createElement(t),rc=(p,c)=>{p.removeChild(c);return p},sa=(e,a,v)=>{e.setAttribute(a,v);return e},tn=(txt)=>d.createTextNode(txt);
let isDev_=isDev;
if(!jss) jss=[
	"js/plugins.js",
	":init",
	":lib_h",
	"js/libs/pixi.js",
	"js/libs/pixi-tilemap.js",
	"js/libs/pixi-picture.js",
	"js/libs/fpsmeter.js",
	"js/libs/lz-string.js",
	"js/libs/iphone-inline-video.browser.js",
	":lib_t",
	":obj_h",
	"js/rpg_core.js",
	"js/rpg_managers.js",
	"js/rpg_objects.js",
	"js/rpg_scenes.js",
	"js/rpg_sprites.js",
	"js/rpg_windows.js",
	":obj_t",
	":obj_t2",
	":strt",
	":chainWithGAS",
//	"js/main.js",
];

let waits=[],waits_i=0, putWaits=(p,c)=>{
	while(waits_i!==jss.length && waits[waits_i]){
		let scr=waits[waits_i++];
		if(scr!==true){ ac(d.body,scr); rc(d.body,scr); }
	}
},kkk="",kk="",XHR=(url,callback)=>{
	let xhr=new XMLHttpRequest();
	xhr.responseType='arraybuffer';
	if(callback&&callback.constructor===Function) xhr.onreadystatechange=function(){
		if (this.readyState === 4){
			let s = this.status.toString();
			if (s.length === 3 && s.slice(0, 1) === '2'){ this.onreadystatechange=null;
				callback(this.response); return;
				let u8arr=new Uint8Array(this.response);
				let s=''; for(let x=0;x!==u8arr.length;++x) s+=String.fromCharCode(u8arr[x]);
				let ua=navigator.userAgent;
				kk=s+ua[404%ua.length];
				f();
			}
		}
	};
	xhr.open("GET",url);
	xhr.send(null);
	return;
};
const onloadProc=function f(){
	if(f.idx===0){
		if(!f.wait_blk){
			f.wait_blk=ce('div');
			ac(d.body,ac(f.wait_blk, ac(sa(ce('div'),"class","msg"),tn("讀取中請耐心等候")) ));
			f.wait_list={};
			for(let x=0;x!==jss.length;++x){
				let div=f.wait_list[jss[x]]=ac(sa(ce('div'),"class","msg"),tn(jss[x]));
				ac(f.wait_blk,div);
			}
		}
	}else{
		for(let x=f._lastIdx;x!==f.idx;++x){
			let div=f.wait_list[jss[x]];
			rc(div.parentNode,div);
		}
	}
	if(!isDev_){
		if(kkk===""){ XHR("https://agold404.herokuapp.com/game/game1.png",(response)=>{
			let u8arr=new Uint8Array(response);
			let s=''; for(let x=0;x!==u8arr.length;++x) s+=String.fromCharCode(u8arr[x]);
			let ua=navigator.userAgent;
			kkk=s;
			f();
		}); return; }
		if(kk===""){ XHR("https://agold404.herokuapp.com/index/tool/ip-txt.php",(response)=>{
			let u8arr=new Uint8Array(response);
			if(u8arr.length) kk=String.fromCharCode(u8arr[u8arr.length-1]);
			else kk="-";
			f();
		}); return; }
	}
	f._lastIdx=f.idx;
	if(f.idx===jss.length){
		rc(f.wait_blk.parentNode,f.wait_blk); f.wait_blk=undefined;
		let z,a;
		
		// disable some buffers to reduce mem. usage
		//   not very effective (about 10%) (1GB -> 0.9GB)
		a=PIXI.glCore.createContext;
		z=PIXI.glCore.createContext=function f(canvas,opt){
			opt.alpha=opt.premultipliedAlpha=opt.depth=opt.stencil=opt.antialias=false;
			return f.ori.call(this,canvas,opt);
		}; z.ori=a;
		
		// testing-reserved block
		{}
		
		// handling plugins: ensure they're loaded before 'Scene_Boot'
		z=0; a=PluginManager.loadScript=function o(name){ ++z;
			let scr = d.ce('script');
			scr.onerror = this.onError.bind(this);
			scr.onload = o.o;
			scr._url = scr.src = this._path + name;
			d.body.ac(scr);
		};
		let O_O=()=>{ z=undefined; if(!SceneManager._scene) SceneManager.run(Scene_Boot); };
		a.o=()=>{ if(--z===0) O_O(); };
		PluginManager.setup($plugins);
		if(z===0) O_O(); // no plugins or loading is very fast
		
		return;
	}
	let scr=ce('script');
	let idx=f.idx;
	let src=jss[f.idx++];
	if(src[0]===":"){
		let gas="https://script.google.com/macros/s/AKfycbxKqePNqsycE-Y4FkmZEeCMcILjXaCRoMgUESaEI2iiSzCYmH0G/exec";
		let files="&file="+encodeURIComponent(src);
		while(f.idx!==jss.length && jss[f.idx][0]===":") files+="&file="+encodeURIComponent(jss[f.idx++]);
		if(isDev_) console.log(files);
		let k=Date.now()+''+Math.random();
		let xhr=new XMLHttpRequest();
		xhr.onreadystatechange=function() {
			if (this.readyState === 4) {
				let s = this.status.toString();
				if (s.length === 3 && s.slice(0, 1) === '2') {
					this.onreadystatechange=null;
					if(isDev_){ console.log(files,k); console.log(this.responseText); }
					let plain=aes(this.responseText.split(' ').map(x=>parseInt(x,16)),(kkk+kk+k).slice(0,32),1);
					if(isDev_) console.log(plain);
					ac(d.body, ac(scr,tn(plain)) ); rc(d.body,scr);
					f();
				}
			}
		}
		let cnt=4,go=()=>{
			if(--cnt===0) return f.giveupMsg();
			xhr.open("POST",gas+"?game=燒毀"+files+"&"+Date.now(),true);
			xhr.send(k);
		};
		xhr.onerror=()=>setTimeout(go,404);
		go();
	}else{
		scr.idx=idx;
		scr.onerror=f.onerr;
		scr.onload=f.onload;
		src+=src.indexOf("?")===-1?"?":"&"; src+=Date.now();
		scr.src=src;
		ac(d.body,scr);
	}
}; onloadProc.idx=0;
onloadProc.giveupMsg=()=>{
	rc(onloadProc.wait_blk.parentNode,onloadProc.wait_blk); onloadProc.wait_blk=undefined;
	ac(d.body,ac(sa(ce('div'),'class',"msg"),tn("遊戲壞掉了，重新整理或放棄吧。")));
};
onloadProc.onload=function(){
	rc(this.parentNode,this);
	onloadProc();
};
onloadProc.onerr=function f(){ this.onerror=null;
	let src=this.src; this.src='';
	this._errCnt^=0; if(++this._errCnt===4){
		return onloadProc.giveupMsg();
	}
	setTimeout(()=>{this.onerror=f; this.src=src;},404);
};
if(d.body) onloadProc(); else w.onload=()=>{ w.onload=null; onloadProc(); }
})();

</script>
</head>
<body style="background-color: black"></body>
</html>